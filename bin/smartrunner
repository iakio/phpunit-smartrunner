#!/usr/bin/env php
<?php
use iakio\phpunit\smartrunner\Utils;
use iakio\phpunit\smartrunner\FileSystem;
use iakio\phpunit\smartrunner\Cache;

if (file_exists(__DIR__ . '/../vendor/autoload.php')) {
    // bin/smartrunner
    require __DIR__ . '/../vendor/autoload.php';
} else {
    // vendor/iakio/phpunit-smartrunner/bin/smartrunner
    require __DIR__ . '/../../../autoload.php';
}

$argv = $_SERVER['argv'];

if (count($argv) > 1) {
    $cache = Cache::instance();
    $cache->loadCache();
    $fs = new FileSystem(getcwd());
    $arg_file = $fs->normalizePath($argv[1]);
    if ($hits = $cache->get($arg_file)) {
        foreach ($hits as $hit) {
            system(implode(DIRECTORY_SEPARATOR, ["vendor", "bin", "phpunit"]) . " " . $hit);
        }
    } else if (Utils::isTestable($arg_file)) {
        system(implode(DIRECTORY_SEPARATOR, ["vendor", "bin", "phpunit"]) . " " . $arg_file);
    }
}
